<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Desi Fitness Coach</title>
    <meta name="theme-color" content="#4CAF50" />
    <style>
        /* ===============================
           Global Styles & Layout
           =============================== */
        :root{
            --brand:#4CAF50;
            --brand-600:#43a047;
            --ink:#2c3e50;
            --sub:#555;
            --bg:#f4f7f6;
            --card:#ffffff;
            --muted:#888;
            --ring:rgba(76,175,80,.25);
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin:0; background:var(--bg); color:#333;
            -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
            display:flex; flex-direction:column;
        }
        #app{
            flex:1; padding-bottom:72px; max-width:900px; margin:0 auto; width:100%;
            background:#fff; box-shadow:0 0 20px rgba(0,0,0,.05); display:flex; flex-direction:column; min-height:calc(100vh - 72px);
        }
        .page{display:none; padding:20px; flex:1; overflow:auto;}
        .page.active{display:flex; flex-direction:column;}

        h1{ text-align:center; color:var(--ink); margin:14px 0 20px; font-weight:800; letter-spacing:.2px}
        h3{ margin:0 0 10px; color:var(--ink); }

        /* ===============================
           Search Bars
           =============================== */
        .search-container{ position:relative; margin-bottom:16px; display:flex; align-items:center;}
        .search-container input{
            width:100%; padding:13px 16px 13px 48px; border:1px solid #e6e6e6; border-radius:28px;
            font-size:1.05em; outline:none; transition:border .2s, box-shadow .2s;
            background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.02) inset;
        }
        .search-container input:focus{ border-color:var(--brand); box-shadow:0 0 0 4px var(--ring); }
        .search-container .search-icon{
            position:absolute; left:14px; display:grid; place-items:center; color:#6b7280;
        }
        .btn{
            appearance:none; border:none; background:var(--brand); color:#fff; font-weight:700;
            padding:12px 16px; border-radius:12px; cursor:pointer; font-size:1rem; transition:transform .05s ease, background .2s;
            box-shadow:0 6px 16px rgba(76,175,80,.18);
        }
        .btn:active{ transform:translateY(1px) }
        .btn:hover{ background:var(--brand-600) }

        /* ===============================
           Cards & Lists
           =============================== */
        .card-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:16px; margin-top:6px;}
        .card{
            background:var(--card); border-radius:16px; padding:22px; text-align:center; cursor:pointer;
            box-shadow:0 8px 24px rgba(0,0,0,.06); transition:transform .2s ease, box-shadow .2s ease;
            display:flex; gap:8px; align-items:center; justify-content:center; min-height:124px;
        }
        .card:hover{ transform:translateY(-4px); box-shadow:0 14px 34px rgba(0,0,0,.1);}
        .card-icon{ font-size:2.6rem; }
        .card-title{ font-size:1.1rem; font-weight:800; color:#333; }

        .results-container{ margin-top:10px; }
        .empty{ text-align:center; color:#777; padding:24px 12px }

        .item{
            background:#fff; border-radius:12px; padding:14px; box-shadow:0 2px 12px rgba(0,0,0,.06);
            margin-bottom:12px; display:flex; gap:14px; align-items:center;
        }
        .item:hover{ transform:translateX(2px); transition:transform .1s }
        .item .thumb{
            width:88px; height:88px; border-radius:10px; object-fit:cover; box-shadow:0 2px 8px rgba(0,0,0,.08);
            background:#f2f2f2;
        }
        .item h3{ margin:0 0 6px; font-size:1.05rem }
        .meta{ color:#666; font-size:.93rem; line-height:1.5 }

        .kpis{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:10px}
        .kpi{
            background:#f7fdf7; border:1px solid #e7f6e7; color:#1b5e20; padding:10px; border-radius:10px;
            text-align:center; font-weight:800; font-size:.95rem;
        }
        .kpi span{ display:block; font-weight:600; color:#2f3f2f; font-size:.85rem }

        .chip{ display:inline-flex; align-items:center; gap:6px; border:1px solid #eee; padding:6px 10px; border-radius:999px; font-size:.9rem; color:#444; background:#fafafa }

        /* ===============================
           Modal
           =============================== */
        .modal{ display:none; position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,.5); align-items:center; justify-content:center; animation:fadeIn .2s ease }
        .modal.open{ display:flex }
        .modal-content{
            background:#fff; width:min(640px,92%); border-radius:16px; padding:22px; position:relative; 
            max-height:80vh; overflow-y: auto; /* FIXED: Added scrolling for modal content */
            box-shadow:0 14px 44px rgba(0,0,0,.24); animation:pop .18s ease;
        }
        .modal-content h2{ margin:0 0 10px; color:var(--ink) }
        .modal-content img{ width:100%; border-radius:12px; margin:10px 0 14px; }
        .close-button{
            position:absolute; top:10px; right:12px; font-size:28px; color:#777; cursor:pointer; line-height:1;
        }
        @keyframes fadeIn{from{opacity:0} to{opacity:1}}
        @keyframes pop{from{ transform:translateY(8px); opacity:0 } to{ transform:translateY(0); opacity:1 }}

        /* ===============================
           Profile
           =============================== */
        .profile-form{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px }
        .profile-form label{ grid-column:1/-1; font-weight:700; color:#444; margin-top:6px }
        .profile-form input{
            width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; font-size:1rem;
        }
        .profile-actions{ grid-column:1/-1; display:flex; gap:10px; margin-top:6px }
        .profile-summary{
            margin-top:16px; background:#e8f5e9; border-radius:12px; padding:14px; color:#1b5e20; box-shadow:0 2px 10px rgba(0,0,0,.05);
        }
        .history-section{ margin-top:18px }
        .history-list{ list-style:none; margin:0; padding:0 }
        .history-list li{
            display:flex; align-items:center; justify-content:space-between; gap:10px;
            background:#fafafa; border:1px solid #eee; padding:10px 12px; border-radius:10px; margin-bottom:8px; font-size:.95rem;
        }
        .pill{ background:#eef7ff; color:#0b63c4; border:1px solid #d7eaff; border-radius:999px; padding:4px 8px; font-size:.8rem; }

        /* ===============================
           Bottom Navigation
           =============================== */
        .bottom-nav{
            position:fixed; bottom:0; left:0; width:100%; background:#fff; display:flex; justify-content:space-around; gap:6px;
            padding:8px 8px env(safe-area-inset-bottom); border-top-left-radius:18px; border-top-right-radius:18px;
            box-shadow:0 -8px 24px rgba(0,0,0,.08); z-index:2000;
        }
        .nav-item{
            flex:1; display:flex; flex-direction:column; align-items:center; gap:2px; padding:8px 6px; border-radius:12px;
            color:#6b7280; text-decoration:none; font-size:.78rem; font-weight:800; letter-spacing:.2px; transition:background .2s, color .2s;
        }
        .nav-item.active{ color:var(--brand); background:#e8f5e9; }
        .nav-item svg{ width:26px; height:26px; fill:currentColor }

        /* Helpers */
        .mt-8{margin-top:8px} .mt-12{margin-top:12px} .mt-16{margin-top:16px} .mt-24{margin-top:24px}
        .sr{position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap}

        /* Responsive tweaks */
        @media (max-width:680px){
            #app{ box-shadow:none; }
            .profile-form{ grid-template-columns:1fr; }
        }
    </style>
</head>
<body>
<div id="app">

    <!-- ===========================
         Dashboard
         =========================== -->
    <div id="dashboard" class="page active" role="region" aria-labelledby="dash-title">
        <h1 id="dash-title">Desi Fitness Coach</h1>

        <div class="search-container">
            <span class="search-icon" aria-hidden="true">
                <!-- Modern search icon -->
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.8 14.4h-.8l-.3-.3a6.5 6.5 0 1 0-1.1 1.1l.3.3v.8l4.9 4.9 1.4-1.4-4.9-4.9zm-6.3 0A4.9 4.9 0 1 1 14.4 9.5 4.9 4.9 0 0 1 9.5 14.4z"/></svg>
            </span>
            <input type="text" id="dashboard-search-input" placeholder="Search any food or exercise..." aria-label="Search any food or exercise"/>
        </div>

        <div class="card-grid" aria-label="Quick actions">
            <div class="card" id="calorie-finder-card" tabindex="0" role="button" aria-label="Open Calorie Finder">
                <span class="card-icon" aria-hidden="true">üçé</span>
                <span class="card-title">Calorie Finder</span>
            </div>
            <div class="card" id="workout-library-card" tabindex="0" role="button" aria-label="Open Workout Library">
                <span class="card-icon" aria-hidden="true">üèãÔ∏è‚Äç‚ôÇÔ∏è</span>
                <span class="card-title">Workout Library</span>
            </div>
        </div>

        <div class="history-section mt-24" id="dashboard-history">
            <h3>Recently Viewed</h3>
            <ul class="history-list" id="dashboard-history-list"></ul>
            <div id="dashboard-empty" class="empty">No recent items yet. Try searching a food (e.g., <span class="pill">1 plate luchi and alur dom</span>) or an exercise (<span class="pill">chest</span>).</div>
        </div>
    </div>

    <!-- ===========================
         Nutrition
         =========================== -->
    <div id="nutrition" class="page" role="region" aria-labelledby="nutrition-title">
        <h1 id="nutrition-title">Nutrition Tracker</h1>

        <div class="search-container">
            <span class="search-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M15.8 14.4h-.8l-.3-.3a6.5 6.5 0 1 0-1.1 1.1l.3.3v.8l4.9 4.9 1.4-1.4-4.9-4.9zm-6.3 0A4.9 4.9 0 1 1 14.4 9.5 4.9 4.9 0 0 1 9.5 14.4z"/></svg>
            </span>
            <input type="text" id="nutrition-search-input" placeholder="e.g., 1 plate luchi and alur dom"/>
        </div>
        <button class="btn" id="nutrition-search-button" aria-label="Get Nutrition Info">Get Nutrition Info</button>

        <div class="results-container" id="nutrition-results" aria-live="polite"></div>
    </div>

    <!-- ===========================
         Workout
         =========================== -->
    <div id="workout" class="page" role="region" aria-labelledby="workout-title">
        <h1 id="workout-title">Workout Library</h1>

        <div class="search-container">
            <span class="search-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M15.8 14.4h-.8l-.3-.3a6.5 6.5 0 1 0-1.1 1.1l.3.3v.8l4.9 4.9 1.4-1.4-4.9-4.9zm-6.3 0A4.9 4.9 0 1 1 14.4 9.5 4.9 4.9 0 0 1 9.5 14.4z"/></svg>
            </span>
            <input type="text" id="workout-search-input" placeholder="Search by body part (e.g., chest) or type (yoga)"/>
        </div>
        <button class="btn" id="workout-search-button" aria-label="Find Exercises">Find Exercises</button>

        <div class="results-container" id="workout-results" aria-live="polite"></div>
    </div>

    <!-- ===========================
         Profile
         =========================== -->
    <div id="profile" class="page" role="region" aria-labelledby="profile-title">
        <h1 id="profile-title">Your Profile</h1>

        <form id="profile-form" class="profile-form" autocomplete="on">
            <label for="name">Name</label>
            <input type="text" id="name" placeholder="Your Name" autocomplete="name"/>

            <label for="age">Age</label>
            <input type="number" id="age" placeholder="Your Age" min="1" max="120"/>

            <label for="weight">Weight (kg)</label>
            <input type="number" id="weight" placeholder="Your Weight" min="1" max="500" step="0.1"/>

            <label for="height">Height (cm)</label>
            <input type="number" id="height" placeholder="Your Height" min="30" max="250" step="0.1"/>

            <div class="profile-actions">
                <button type="submit" class="btn">Save Profile</button>
                <button type="button" id="clear-profile" class="btn" style="background:#ef4444">Clear</button>
            </div>
        </form>

        <div class="profile-summary" id="profile-summary">
            <div><strong>Name:</strong> <span id="summary-name">N/A</span></div>
            <div><strong>Age:</strong> <span id="summary-age">N/A</span></div>
            <div><strong>Weight:</strong> <span id="summary-weight">N/A</span> kg</div>
            <div><strong>Height:</strong> <span id="summary-height">N/A</span> cm</div>
        </div>

        <div class="history-section">
            <h3>Food Search History</h3>
            <ul class="history-list" id="food-history-list"></ul>
            <div id="food-history-empty" class="empty">No food searches yet.</div>
        </div>

        <div class="history-section">
            <h3>Exercise View History</h3>
            <ul class="history-list" id="exercise-history-list"></ul>
            <div id="exercise-history-empty" class="empty">No exercises viewed yet.</div>
        </div>
    </div>

    <!-- ===========================
         Modal: Exercise Details
         =========================== -->
    <div id="workout-detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modal-exercise-name">
        <div class="modal-content">
            <span class="close-button" role="button" aria-label="Close">&times;</span>
            <h2 id="modal-exercise-name"></h2>
            <img id="modal-exercise-gif" src="" alt="Exercise animation"/>
            <p class="meta"><strong>Body Part:</strong> <span id="modal-bodypart"></span></p>
            <p class="meta"><strong>Target Muscle:</strong> <span id="modal-target-muscle"></span></p>
            <p class="meta"><strong>Equipment:</strong> <span id="modal-equipment"></span></p>
            <div class="mt-12">
                <h3>Instructions</h3>
                <div id="modal-instructions" class="meta"></div>
            </div>
            <div class="mt-12">
                <h3>Secondary Muscles</h3>
                <div id="modal-secondary" class="meta"></div>
            </div>
        </div>
    </div>

</div>

<!-- ===========================
     Bottom Navigation (Fixed)
     =========================== -->
<nav class="bottom-nav" aria-label="Bottom navigation">
    <a href="#dashboard" class="nav-item active" data-page="dashboard" aria-label="Dashboard">
        <!-- High-quality home icon -->
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3 2 12h3v8h6v-6h2v6h6v-8h3L12 3z"/></svg>
        <span>Dashboard</span>
    </a>
    <a href="#nutrition" class="nav-item" data-page="nutrition" aria-label="Nutrition">
        <!-- Apple-like icon -->
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16.2 13.6c.1-2.3 1.9-3.4 2-3.5-1.1-1.6-2.8-1.8-3.4-1.8-1.4-.1-2.6.8-3.2.8s-1.7-.7-2.8-.7c-1.4 0-2.7.8-3.4 2-.1.1-1.5 2.6-.4 5.4 0 0 2.3 4.3 4.2 4.2 1-.1 1.8-.7 2.7-.7s1.7.7 2.8.7c2.1 0 3.6-2.1 4.3-4.2-.1-.1-3-1.1-2.8-3.2zM14.7 5.8c.6-.7 1-1.7.9-2.7-.9 0-2 .6-2.6 1.3-.6.7-1.1 1.7-.9 2.7 1 .1 2-.6 2.6-1.3z"/></svg>
        <span>Nutrition</span>
    </a>
    <a href="#workout" class="nav-item" data-page="workout" aria-label="Workout">
        <!-- Dumbbell icon -->
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M2 10h2v4H2v-4zm3-3h2v10H5V7zm4 3h6v4H9v-4zm8-3h2v10h-2V7zm3 3h2v4h-2v-4z"/></svg>
        <span>Workout</span>
    </a>
    <a href="#profile" class="nav-item" data-page="profile" aria-label="Profile">
        <!-- User icon -->
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12zm0 2c-3 0-9 1.6-9 4.8V21h18v-2.2C21 15.6 15 14 12 14z"/></svg>
        <span>Profile</span>
    </a>
</nav>

<script>
/* =========================================================
   API Keys (from your message) -- used directly here
   ========================================================= */
const NUTRITIONIX_APP_ID = '14f6dcde';
const NUTRITIONIX_APP_KEY = 'c5b6e6d0e1e4ea3d8ebdcd1a6ff67d0a';
const API_NINJAS_KEY = 'efe6c2396amshca58838cfcf1fa6p1e841bjsn3ebd7b50839d';
const PEXELS_API_KEY = 'GiwdENpRb6f5TkWmordUixunWpfGyU3KRJtYPykVzdGDSxOgR5hKqlpf';

/* =========================================================
   DOM Refs
   ========================================================= */
const pages = document.querySelectorAll('.page');
const navItems = document.querySelectorAll('.nav-item');

/* Dashboard */
const dashboardSearchInput = document.getElementById('dashboard-search-input');
const calorieFinderCard   = document.getElementById('calorie-finder-card');
const workoutLibraryCard  = document.getElementById('workout-library-card');
const dashboardHistoryList = document.getElementById('dashboard-history-list');
const dashboardEmpty = document.getElementById('dashboard-empty');

/* Nutrition */
const nutritionSearchInput  = document.getElementById('nutrition-search-input');
const nutritionSearchButton = document.getElementById('nutrition-search-button');
const nutritionResultsDiv   = document.getElementById('nutrition-results');

/* Workout */
const workoutSearchInput  = document.getElementById('workout-search-input');
const workoutSearchButton = document.getElementById('workout-search-button');
const workoutResultsDiv   = document.getElementById('workout-results');

/* Modal */
const workoutDetailModal   = document.getElementById('workout-detail-modal');
const modalCloseButton     = workoutDetailModal.querySelector('.close-button');
const modalExerciseName    = document.getElementById('modal-exercise-name');
const modalExerciseGif     = document.getElementById('modal-exercise-gif');
const modalBodyPart        = document.getElementById('modal-bodypart');
const modalTargetMuscle    = document.getElementById('modal-target-muscle');
const modalEquipment       = document.getElementById('modal-equipment');
const modalInstructions    = document.getElementById('modal-instructions');
const modalSecondary       = document.getElementById('modal-secondary');

/* Profile */
const profileForm     = document.getElementById('profile-form');
const nameInput       = document.getElementById('name');
const ageInput        = document.getElementById('age');
const weightInput     = document.getElementById('weight');
const heightInput     = document.getElementById('height');
const summaryName     = document.getElementById('summary-name');
const summaryAge      = document.getElementById('summary-age');
const summaryWeight   = document.getElementById('summary-weight');
const summaryHeight   = document.getElementById('summary-height');
const clearProfileBtn = document.getElementById('clear-profile');
const foodHistoryList = document.getElementById('food-history-list');
const exerciseHistoryList = document.getElementById('exercise-history-list');
const foodHistoryEmpty = document.getElementById('food-history-empty');
const exerciseHistoryEmpty = document.getElementById('exercise-history-empty');

/* =========================================================
   Storage Helpers
   ========================================================= */
const STORAGE_KEYS = {
  PROFILE: 'dfc_profile',
  FOOD_HISTORY: 'dfc_food_history',
  EX_HISTORY: 'dfc_exercise_history'
};

function saveProfile(data){
  try { localStorage.setItem(STORAGE_KEYS.PROFILE, JSON.stringify(data)); }
  catch(e){ console.warn('Failed to save profile', e); }
}
function getProfile(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.PROFILE)) || null; }
  catch{ return null; }
}

function pushHistory(key, item, limit=12){
  const arr = getHistory(key);
  arr.unshift(item);
  // De-dup by id/text where available
  const seen = new Set();
  const deduped = [];
  for (const it of arr){
    const sig = it.sig || it.id || it.q || JSON.stringify(it);
    if (!seen.has(sig)){
      seen.add(sig);
      deduped.push(it);
    }
  }
  try { localStorage.setItem(key, JSON.stringify(deduped.slice(0, limit))); }
  catch(e){ console.warn('Failed to pushHistory', e); }
}
function getHistory(key){
  try { return JSON.parse(localStorage.getItem(key)) || []; }
  catch{ return []; }
}

/* =========================================================
   SPA Navigation
   ========================================================= */
function showPage(id){
  pages.forEach(p => p.classList.toggle('active', p.id === id));
  navItems.forEach(n => n.classList.toggle('active', n.dataset.page === id));
  history.pushState(null, '', `#${id}`);

  if (id === 'profile'){
    loadProfileData();
    renderHistory();
  } else if (id === 'dashboard'){
    renderDashboardHistory();
  }
}
window.addEventListener('hashchange', () => {
  const id = location.hash.slice(1) || 'dashboard';
  showPage(id);
});
document.addEventListener('DOMContentLoaded', () => {
  showPage(location.hash.slice(1) || 'dashboard');
});
navItems.forEach(item => item.addEventListener('click', e => {
  e.preventDefault();
  showPage(item.dataset.page);
}));

/* Quick cards */
calorieFinderCard.addEventListener('click', () => showPage('nutrition'));
calorieFinderCard.addEventListener('keypress', (e)=>{ if(e.key==='Enter') showPage('nutrition'); });
workoutLibraryCard.addEventListener('click', () => showPage('workout'));
workoutLibraryCard.addEventListener('keypress', (e)=>{ if(e.key==='Enter') showPage('workout'); });

/* =========================================================
   DASHBOARD Unified Search (smart route)
   ========================================================= */
dashboardSearchInput.addEventListener('keypress', async (e) => {
  if (e.key !== 'Enter') return;
  const query = dashboardSearchInput.value.trim();
  if (!query) return;

  // Lightweight heuristic to route to Nutrition vs Workout
  const foodKeywords = ['plate','bowl','curry','rice','roti','naan','dal','paneer','chicken','fish','veg','soup','breakfast','lunch','dinner','calories','nutrition','biriyani','biryani','paratha','luchi','pulao','idli','dosa','chole','bhature','poha','upma','sambar','rasgulla','sandesh','jalebi','luchi','alur'];
  const exerciseKeywords = ['chest','legs','arms','shoulders','back','glutes','abs','core','yoga','cardio','biceps','triceps','hamstrings','quads','calves','forearms','stretch','neck','upper','lower','push','pull','press','squat','deadlift','run','plank'];

  const isFood = foodKeywords.some(k => query.toLowerCase().includes(k));
  if (isFood){
    showPage('nutrition');
    nutritionSearchInput.value = query;
    await handleNutritionSearch();
  } else {
    showPage('workout');
    workoutSearchInput.value = query;
    await handleWorkoutSearch();
  }
});

/* =========================================================
   Nutrition: Robust Nutritionix Natural Language call
   - Rewritten to be more resilient, include additional headers,
     fallback numeric keys, and image placeholders.
   ========================================================= */
nutritionSearchButton.addEventListener('click', handleNutritionSearch);
nutritionSearchInput.addEventListener('keypress', (e)=>{ if (e.key==='Enter') handleNutritionSearch(); });

async function handleNutritionSearch(){
  const q = (nutritionSearchInput.value || '').trim();
  if (!q){
    renderNutritionMessage('Type a dish or quantity, e.g., <b>1 plate luchi and alur dom</b>.');
    return;
  }
  renderNutritionLoading();

  const PLACEHOLDER_FOOD = `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='300'><rect width='100%' height='100%' fill='%23f2f2f2'/><text x='50%' y='50%' font-size='18' dominant-baseline='middle' text-anchor='middle' fill='%23777' font-family='Verdana,Arial'>No Image</text></svg>`;

  try{
    // Build request; include x-remote-user-id as recommended by some Nutritionix docs
    const body = { query: q };
    const resp = await fetch('https://trackapi.nutritionix.com/v2/natural/nutrients', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'x-app-id': NUTRITIONIX_APP_ID,
        'x-app-key': NUTRITIONIX_APP_KEY,
        'x-remote-user-id': '0'
      },
      body: JSON.stringify(body)
    });

    if (!resp.ok){
      const text = await resp.text().catch(()=> '');
      throw new Error(`Nutritionix API returned ${resp.status} ${text}`);
    }
    const data = await resp.json();

    if (!data || !Array.isArray(data.foods) || data.foods.length === 0){
      renderNutritionMessage('No results. Try phrasing like <b>2 roti with dal</b> or <b>1 bowl chicken biryani</b>.');
      return;
    }

    // Aggregate totals, with safe keys fallback
    const totals = data.foods.reduce((acc, f) => {
      acc.cal += safeNum(f, 'nf_calories', 'calories', 'cal');
      acc.pro += safeNum(f, 'nf_protein', 'protein', 'protein_g');
      acc.fat += safeNum(f, 'nf_total_fat', 'total_fat', 'fat');
      acc.carb+= safeNum(f, 'nf_total_carbohydrate', 'total_carbohydrate', 'carbohydrate', 'carb');
      return acc;
    }, {cal:0, pro:0, fat:0, carb:0});

    // Build list items - FIXED: Remove redundant calorie/protein boxes below each food item
    const list = data.foods.map(f => {
      const imgUrl = (f.photo && (f.photo.highres || f.photo.thumb)) || PLACEHOLDER_FOOD;
      const servingInfo = f.serving_qty ? `${f.serving_qty} ${f.serving_unit || ''}` : '';
      
      return `
      <div class="item">
        <img class="thumb" alt="${escapeHtml(f.food_name || 'food')}" src="${escapeAttr(imgUrl)}" onerror="this.onerror=null;this.src='${PLACEHOLDER_FOOD}'">
        <div style="flex:1">
          <h3>${titleCase(escapeHtml(f.food_name || 'Unknown'))}</h3>
          <div class="meta">
            ${servingInfo ? `<span class="chip">${escapeHtml(servingInfo)}</span>` : ''}
            ${f.brand_name ? `<span class="chip">${escapeHtml(f.brand_name)}</span>` : ''}
          </div>
        </div>
      </div>
      `;
    }).join('');

    nutritionResultsDiv.innerHTML = `
      <div class="item" style="border:2px solid #e7f6e7">
        <div style="flex:1">
          <h3>Total for: ${escapeHtml(q)}</h3>
          <div class="kpis">
            <div class="kpi">${round1(totals.cal)}<span>Total kcal</span></div>
            <div class="kpi">${round1(totals.pro)}g<span>Protein</span></div>
            <div class="kpi">${round1(totals.fat)}g<span>Fat</span></div>
            <div class="kpi">${round1(totals.carb)}g<span>Carbs</span></div>
          </div>
        </div>
      </div>
      ${list}
    `;

    // Store search in history (sig helps de-dup)
    pushHistory(STORAGE_KEYS.FOOD_HISTORY, { sig: q, q, when: Date.now() });
    renderHistory();
    renderDashboardHistory();

  } catch (err) {
    // Friendly error; show useful message
    renderNutritionMessage('‚ö†Ô∏è Unable to fetch nutrition right now. ' + escapeHtml(err.message || 'Network error'));
    console.error('Nutritionix error', err);
  }
}

function renderNutritionLoading(){
  nutritionResultsDiv.innerHTML = `
    <div class="item"><div class="meta">Fetching nutrition details‚Ä¶</div></div>
  `;
}
function renderNutritionMessage(html){
  nutritionResultsDiv.innerHTML = `<div class="empty">${html}</div>`;
}

/* =========================================================
   WORKOUT: Completely Rebuilt with API-Ninjas + Pexels API
   ========================================================= */
workoutSearchButton.addEventListener('click', handleWorkoutSearch);
workoutSearchInput.addEventListener('keypress', (e)=>{ if (e.key==='Enter') handleWorkoutSearch(); });

const PLACEHOLDER_EXERCISE = `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='600' height='350'><rect width='100%' height='100%' fill='%23f2f2f2'/><text x='50%' y='50%' font-size='20' dominant-baseline='middle' text-anchor='middle' fill='%23777' font-family='Verdana,Arial'>Loading image...</text></svg>`;

async function handleWorkoutSearch(){
  const qRaw = workoutSearchInput.value || '';
  const q = qRaw.trim().toLowerCase();
  if (!q){
    renderWorkoutMessage('Type a body part (e.g., <b>chest</b>) or style (e.g., <b>yoga</b>, <b>cardio</b>).');
    return;
  }
  renderWorkoutLoading();

  try{
    const headers = {
      'X-RapidAPI-Key': API_NINJAS_KEY,
      'X-RapidAPI-Host': 'exercises-by-api-ninjas.p.rapidapi.com'
    };

    // Call the API-Ninjas exercises API with multiple search strategies
    let results = [];
    
    // Try name search first
    const nameResponse = await fetch(`https://exercises-by-api-ninjas.p.rapidapi.com/v1/exercises?name=${encodeURIComponent(q)}`, {
      headers: headers
    });
    
    if (nameResponse.ok) {
      const nameResults = await nameResponse.json();
      if (nameResults && nameResults.length > 0) {
        results = nameResults;
      }
    }
    
    // If no results from name search, try muscle search
    if (results.length === 0) {
      const muscleResponse = await fetch(`https://exercises-by-api-ninjas.p.rapidapi.com/v1/exercises?muscle=${encodeURIComponent(q)}`, {
        headers: headers
      });
      
      if (muscleResponse.ok) {
        const muscleResults = await muscleResponse.json();
        if (muscleResults && muscleResults.length > 0) {
          results = muscleResults;
        }
      }
    }

    // If still no results, try type search
    if (results.length === 0) {
      const typeResponse = await fetch(`https://exercises-by-api-ninjas.p.rapidapi.com/v1/exercises?type=${encodeURIComponent(q)}`, {
        headers: headers
      });
      
      if (typeResponse.ok) {
        const typeResults = await typeResponse.json();
        if (typeResults && typeResults.length > 0) {
          results = typeResults;
        }
      }
    }

    if (!results || results.length === 0){
      renderWorkoutMessage('No exercises found. Try a simpler keyword like <b>back</b>, <b>legs</b>, <b>yoga</b>, <b>cardio</b>.');
      return;
    }

    // Limit results and fetch images for each
    const limited = results.slice(0, 20);
    
    // Create exercise items with placeholder images
    workoutResultsDiv.innerHTML = limited.map(ex => {
      return `
      <div class="item exercise" data-ex='${escapeAttr(JSON.stringify(ex))}'>
        <img class="thumb exercise-image" loading="lazy" src="${PLACEHOLDER_EXERCISE}" alt="${escapeHtml(ex.name || 'exercise')}"/>
        <div style="flex:1">
          <h3>${titleCase(escapeHtml(ex.name || 'Unknown'))}</h3>
          <div class="meta">
            <span class="chip">${titleCase(escapeHtml(ex.muscle || 'N/A'))}</span>
            <span class="chip">${titleCase(escapeHtml(ex.type || 'N/A'))}</span>
            <span class="chip">Equip: ${titleCase(escapeHtml(ex.equipment || 'None'))}</span>
          </div>
        </div>
      </div>
      `;
    }).join('');

    // Fetch images for each exercise asynchronously
    limited.forEach(async (ex, index) => {
      try {
        const imageUrl = await fetchExerciseImage(ex.name);
        const exerciseItems = workoutResultsDiv.querySelectorAll('.exercise');
        if (exerciseItems[index]) {
          const imgElement = exerciseItems[index].querySelector('.exercise-image');
          if (imgElement && imageUrl) {
            imgElement.src = imageUrl;
          }
        }
      } catch (error) {
        console.warn(`Failed to fetch image for ${ex.name}:`, error);
      }
    });

    // Bind clicks to open modal (re-query to attach handlers)
    workoutResultsDiv.querySelectorAll('.exercise').forEach(el => {
      el.addEventListener('click', async () => {
        let ex;
        try{ ex = JSON.parse(el.dataset.ex); } catch(e){ console.warn('Failed parse exercise dataset', e); return; }
        
        // Fetch high-quality image for the modal
        try {
          const modalImageUrl = await fetchExerciseImage(ex.name);
          if (modalImageUrl) {
            ex.imageUrl = modalImageUrl;
          }
        } catch (error) {
          console.warn(`Failed to fetch modal image for ${ex.name}:`, error);
        }
        
        openExerciseModal(ex);
        pushHistory(STORAGE_KEYS.EX_HISTORY, {
          id: ex.name, name: ex.name, bodyPart: ex.muscle, when: Date.now()
        });
        renderHistory();
        renderDashboardHistory();
      });
    });

  }catch(err){
    renderWorkoutMessage('‚ö†Ô∏è Unable to fetch exercises right now. ' + escapeHtml(err.message || 'Network error'));
    console.error('API-Ninjas error', err);
  }
}

// Function to fetch exercise image from Pexels API
async function fetchExerciseImage(exerciseName) {
  try {
    // Search for exercise-related images
    const response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(exerciseName + ' exercise')}&per_page=1`, {
      headers: {
        'Authorization': PEXELS_API_KEY
      }
    });
    
    if (!response.ok) {
      throw new Error(`Pexels API returned ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.photos && data.photos.length > 0) {
      // Return the medium-sized image
      return data.photos[0].src.medium;
    }
    
    // Fallback to a generic fitness image if no specific exercise image found
    const fallbackResponse = await fetch(`https://api.pexels.com/v1/search?query=fitness workout&per_page=1`, {
      headers: {
        'Authorization': PEXELS_API_KEY
      }
    });
    
    if (fallbackResponse.ok) {
      const fallbackData = await fallbackResponse.json();
      if (fallbackData.photos && fallbackData.photos.length > 0) {
        return fallbackData.photos[0].src.medium;
      }
    }
    
    return null;
  } catch (error) {
    console.warn('Error fetching exercise image:', error);
    return null;
  }
}

function renderWorkoutLoading(){
  workoutResultsDiv.innerHTML = `<div class="item"><div class="meta">Loading exercises‚Ä¶</div></div>`;
}
function renderWorkoutMessage(html){
  workoutResultsDiv.innerHTML = `<div class="empty">${html}</div>`;
}

/* Modal logic with improved image handling */
function openExerciseModal(ex){
  modalExerciseName.textContent = titleCase(ex.name || 'Exercise');

  // Use the image URL if available, otherwise use placeholder
  if (ex.imageUrl) {
    modalExerciseGif.src = ex.imageUrl;
    modalExerciseGif.alt = `${ex.name} exercise image`;
  } else {
    modalExerciseGif.src = PLACEHOLDER_EXERCISE;
    modalExerciseGif.alt = "Exercise image not available";
  }
  
  modalExerciseGif.onerror = function(){ 
    this.onerror = null; 
    this.src = PLACEHOLDER_EXERCISE;
    this.alt = "Exercise image not available";
  };

  modalBodyPart.textContent = titleCase(ex.muscle || 'N/A');
  modalTargetMuscle.textContent = titleCase(ex.muscle || 'N/A'); // API-Ninjas uses 'muscle' for target
  modalEquipment.textContent = titleCase(ex.equipment || 'N/A');

  // Format instructions
  const instructions = ex.instructions || '';
  const instructionList = instructions.split(/\d+\./).filter(item => item.trim() !== '');
  modalInstructions.innerHTML = instructionList.length ? 
    `<ol>${instructionList.map(i => `<li>${escapeHtml(i.trim())}</li>`).join('')}</ol>` : 
    'No instructions provided.';

  // API-Ninjas doesn't provide secondary muscles, so leave empty
  modalSecondary.innerHTML = '--';

  workoutDetailModal.classList.add('open');
  workoutDetailModal.setAttribute('aria-hidden','false');
}
function closeExerciseModal(){
  workoutDetailModal.classList.remove('open');
  workoutDetailModal.setAttribute('aria-hidden','true');
}
modalCloseButton.addEventListener('click', closeExerciseModal);
workoutDetailModal.addEventListener('click', (e)=>{ if (e.target === workoutDetailModal) closeExerciseModal(); });
document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeExerciseModal(); });

/* =========================================================
   PROFILE: Save/Load + Histories
   - FIXED: Profile data now persists using localStorage
   ========================================================= */
profileForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const profile = {
    name: nameInput.value.trim(),
    age:   toNumber(ageInput.value),
    weight: toNumber(weightInput.value),
    height: toNumber(heightInput.value),
    updatedAt: Date.now()
  };
  saveProfile(profile);
  loadProfileData();
});
clearProfileBtn.addEventListener('click', ()=>{
  try { localStorage.removeItem(STORAGE_KEYS.PROFILE); } catch(e){ console.warn('Failed to clear profile', e); }
  loadProfileData();
  profileForm.reset();
});

function loadProfileData(){
  const p = getProfile();
  if (p){
    nameInput.value = p.name || '';
    ageInput.value = p.age || '';
    weightInput.value = p.weight || '';
    heightInput.value = p.height || '';
    summaryName.textContent = p.name || 'N/A';
    summaryAge.textContent = p.age || 'N/A';
    summaryWeight.textContent = p.weight || 'N/A';
    summaryHeight.textContent = p.height || 'N/A';
  }else{
    summaryName.textContent = 'N/A';
    summaryAge.textContent   = 'N/A';
    summaryWeight.textContent= 'N/A';
    summaryHeight.textContent= 'N/A';
  }
}
function renderHistory(){
  // Food history
  const foods = getHistory(STORAGE_KEYS.FOOD_HISTORY);
  foodHistoryList.innerHTML = foods.map(f => `
    <li>
      <span>${escapeHtml(f.q)}</span>
      <span class="pill">${timeAgo(f.when)}</span>
    </li>
  `).join('');
  foodHistoryEmpty.style.display = foods.length ? 'none' : 'block';

  // Exercise history
  const exs = getHistory(STORAGE_KEYS.EX_HISTORY);
  exerciseHistoryList.innerHTML = exs.map(x => `
    <li>
      <span>${titleCase(x.name || x.id)}</span>
      <span class="pill">${timeAgo(x.when)}</span>
    </li>
  `).join('');
  exerciseHistoryEmpty.style.display = exs.length ? 'none' : 'block';
}

function renderDashboardHistory(){
  const foods = getHistory(STORAGE_KEYS.FOOD_HISTORY);
  const exs = getHistory(STORAGE_KEYS.EX_HISTORY);

  const items = [];
  foods.slice(0,4).forEach(f => items.push({type:'food', title:f.q, when:f.when}));
  exs.slice(0,4).forEach(x => items.push({type:'exercise', title:x.name || x.id, when:x.when}));

  // sort by recency
  items.sort((a,b)=> (b.when||0)-(a.when||0));

  dashboardHistoryList.innerHTML = items.slice(0,6).map(it => `
    <li>
      <span>${escapeHtml(titleCase(it.title))}</span>
      <span class="pill">${it.type === 'food' ? 'Food' : 'Exercise'} ‚Ä¢ ${timeAgo(it.when)}</span>
    </li>
  `).join('');

  dashboardEmpty.style.display = items.length ? 'none' : 'block';
}

/* =========================================================
   Utilities (helpers used across code)
   ========================================================= */
function titleCase(s=''){
  try { return String(s).replace(/\w\S*/g, (t)=> t.charAt(0).toUpperCase()+t.slice(1)); }
  catch { return s; }
}
function round1(n){ return Math.round((Number(n) + Number.EPSILON) * 10) / 10; }
function toNumber(v){ const n = parseFloat(v); return isFinite(n) ? n : ''; }
function escapeHtml(str=''){
  str = String(str || '');
  return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function escapeAttr(str=''){
  return escapeHtml(String(str || '')).replace(/"/g,'&quot;');
}
function timeAgo(ts){
  if (!ts) return '';
  const s = Math.floor((Date.now()-ts)/1000);
  if (s < 60) return `${s}s ago`;
  const m = Math.floor(s/60); if (m < 60) return `${m}m ago`;
  const h = Math.floor(m/60); if (h < 24) return `${h}h ago`;
  const d = Math.floor(h/24); return `${d}d ago`;
}

/* Safe numeric extractor: check multiple possible keys and return number or 0 */
function safeNum(obj, ...keys){
  if (!obj) return 0;
  for (const k of keys){
    if (Object.prototype.hasOwnProperty.call(obj, k)){
      const v = obj[k];
      const n = Number(v);
      if (!Number.isNaN(n) && isFinite(n)) return n;
    }
  }
  return 0;
}

/* URL validator for image sources */
function isValidUrl(s){
  if (!s) return false;
  try {
    const u = new URL(s);
    return (u.protocol === 'http:' || u.protocol === 'https:');
  } catch(e){ return false; }
}

/* Initial load */
document.addEventListener('DOMContentLoaded', ()=>{
  loadProfileData();
  renderHistory();
  renderDashboardHistory();
});
</script>
</body>
</html>
